{% extends 'base.html' %}
{% block title %}Lista de Productos{% endblock %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>üì¶ Lista de Productos</h2>
    <div class="d-flex gap-2">
        <a href="{% url 'crear_categoria' %}" class="btn btn-secondary">‚ûï Agregar Categor√≠a</a>
        <a href="{% url 'agregar_producto' %}" class="btn btn-success">‚ûï Agregar nuevo producto</a>
    </div>
</div>

<!-- B√∫squeda y filtros autom√°ticos -->
<div class="mb-3">
    <div class="row g-2">
        <div class="col-md-8">
            <input type="text" id="search-input" class="form-control" placeholder="üîç Buscar por c√≥digo, nombre o c√≥digo de barra..." value="{{ query }}" autocomplete="off">
        </div>
        <div class="col-md-4">
            <select id="categoria-select" class="form-select">
                <option value="">üìÇ Todas las categor√≠as</option>
                {% for c in categorias %}
                    <option value="{{ c.id }}" {% if categoria_seleccionada == c.id|stringformat:"s" %}selected{% endif %}>
                        {{ c.nombre }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </div>
    <small class="text-muted">üí° La b√∫squeda se actualiza autom√°ticamente mientras escribes</small>
</div>

<!-- Indicador de carga -->
<div id="loading-indicator" class="alert alert-info d-none">
    ‚è≥ Cargando productos...
</div>

<!-- Tabla de productos -->
<div id="productos-container">
    <table class="table table-bordered table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>C√≥digo / ID</th>
                <th>C√≥digo de Barra</th>
                <th>Nombre</th>
                <th>Precio</th>
                <th>Categor√≠a</th>
                <th>Stock</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="productos-tbody">
            {% for producto in productos %}
            <tr {% if producto.necesita_restock %}class="table-warning"{% endif %}>
                <td>{{ producto.codigo }}</td>
                <td>{{ producto.codigo_barra|default:"‚Äî" }}</td>
                <td>{{ producto.nombre }}</td>
                <td>L {{ producto.precio|floatformat:2 }}</td>
                <td>
                    {% if producto.categoria %}
                        {{ producto.categoria.nombre }}
                    {% else %}
                        <span class="text-muted">‚Äî</span>
                    {% endif %}
                </td>
                <td>
                    <span class="badge {% if producto.necesita_restock %}bg-warning text-dark{% else %}bg-success{% endif %}">
                        {{ producto.stock }}
                    </span>
                </td>
                <td>
                    <a href="{% url 'editar_producto' producto.id %}" class="btn btn-warning btn-sm" title="Editar">‚úèÔ∏è</a>
                    <a href="{% url 'eliminar_producto' producto.id %}" class="btn btn-danger btn-sm" title="Eliminar"
                       onclick="return confirm('¬øSeguro que deseas eliminar este producto?')">üóëÔ∏è</a>
                </td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="7" class="text-center text-muted">No hay productos registrados.</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Total de resultados -->
<div class="alert alert-secondary">
    <strong>Total de productos:</strong> <span id="total-productos">{{ productos.count }}</span>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('search-input');
    const categoriaSelect = document.getElementById('categoria-select');
    const productosTbody = document.getElementById('productos-tbody');
    const productosContainer = document.getElementById('productos-container');
    const loadingIndicator = document.getElementById('loading-indicator');
    const totalProductos = document.getElementById('total-productos');
    
    let timeoutId = null;

    // Funci√≥n para hacer la b√∫squeda autom√°tica
    function buscarProductos() {
        const query = searchInput.value.trim();
        const categoriaId = categoriaSelect.value;
        
        // Construir URL con par√°metros
        let url = '/productos/?';
        if (query) url += `q=${encodeURIComponent(query)}&`;
        if (categoriaId) url += `categoria=${categoriaId}&`;
        
        // Mostrar indicador de carga
        loadingIndicator.classList.remove('d-none');
        
        // Hacer petici√≥n AJAX
        fetch(url, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            // Crear un elemento temporal para parsear el HTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Extraer solo el tbody
            const nuevoTbody = doc.querySelector('#productos-tbody');
            if (nuevoTbody) {
                productosTbody.innerHTML = nuevoTbody.innerHTML;
            }
            
            // Actualizar total
            const filas = productosTbody.querySelectorAll('tr');
            const vacio = filas.length === 1 && filas[0].querySelector('td[colspan]');
            totalProductos.textContent = vacio ? '0' : filas.length;
            
            // Ocultar indicador
            loadingIndicator.classList.add('d-none');
            
            // Actualizar URL sin recargar (para que funcione el back del navegador)
            if (query || categoriaId) {
                window.history.pushState({}, '', url);
            } else {
                window.history.pushState({}, '', '/productos/');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            loadingIndicator.classList.add('d-none');
            productosTbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger">‚ùå Error al cargar productos</td></tr>';
        });
    }

    // B√∫squeda mientras escribe (con delay de 300ms)
    searchInput.addEventListener('input', () => {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
            buscarProductos();
        }, 300);
    });

    // Filtro de categor√≠a inmediato
    categoriaSelect.addEventListener('change', () => {
        buscarProductos();
    });

    // B√∫squeda al presionar Enter
    searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            clearTimeout(timeoutId);
            buscarProductos();
        }
    });

    // Manejar bot√≥n "atr√°s" del navegador
    window.addEventListener('popstate', () => {
        location.reload();
    });
});
</script>

<style>
/* Animaci√≥n suave para la tabla */
#productos-tbody tr {
    transition: background-color 0.2s ease;
}

#productos-tbody tr:hover {
    background-color: var(--table-hover-dark);
}

body.light-mode #productos-tbody tr:hover {
    background-color: var(--table-hover-light);
}

/* Indicador de carga */
#loading-indicator {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 1000;
    animation: fadeIn 0.3s;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Badges de stock */
.badge {
    font-size: 14px;
    padding: 6px 10px;
}
</style>

{% endblock %}