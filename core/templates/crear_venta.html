{% extends 'base.html' %}
{% block title %}Crear Venta{% endblock %}
{% block content %}

<div class="container mt-4">
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <h2 class="mb-3">üßæ Registrar Venta</h2>

  <form method="post" action="{% url 'crear_venta' %}" id="venta-form">
    {% csrf_token %}
    {{ formset.management_form }}

    <div class="row g-3">
      <!-- Columna izquierda: C√≥digo y cliente -->
      <div class="col-md-4">
        <label class="form-label">üîé C√≥digo o barra:</label>
        <div class="input-group mb-2">
            <input type="text" id="codigo_input" class="form-control" placeholder="Ej: 12345 o ABC001" autofocus>
         <button type="button" class="btn btn-primary btn-sm" id="add-by-code-btn" style="height: 45px; margin-left: 5px;">Agregar</button>
        </div>
        <div id="error-msg" class="text-danger small"></div>

        <h5 class="mt-4">üßç Cliente</h5>
          {{ cliente_form.cliente }}
  

        <div class="mb-2">{{ cliente_form.tipo_pago }}</div>

        <h5 class="mt-4">üí∞ Total:</h5>
        <h3>L <span id="total-display">0.00</span></h3>

        <button type="submit" class="btn btn-success w-100 mt-3" id="vender-btn" disabled>üí∞ Vender</button>
      </div>

      <!-- Columna central: Tabla de productos -->
      <div class="col-md-8">
        <table class="table table-bordered align-middle" id="tabla-productos">
          <thead class="table-light">
            <tr>
              <th>C√≥digo</th>
              <th>Producto</th>
              <th style="width: 100px;">Cant.</th>
              <th style="width: 120px;">Precio</th>
              <th style="width: 100px;">Desc. %</th>
              <th style="width: 100px;">ISV</th>
              <th>Subtotal</th>

              <th style="width: 60px;">‚ùå</th>
            </tr>
          </thead>
          <tbody id="tbody-productos"></tbody>
        </table>
      </div>
    </div>
  </form>

  <!-- Panel de accesos r√°pidos -->
  <div class="row mt-4">
    <div class="col-md-12">
      <h6>‚ö° Accesos r√°pidos</h6>
      <div class="d-flex flex-wrap gap-2">
        <button type="button" class="btn btn-outline-primary quick-product" data-codigo="ACEITE10W30">Aceite Castrol 10W30</button>
        <button type="button" class="btn btn-outline-primary quick-product" data-codigo="BAT12V">Bater√≠a 12V</button>
        <button type="button" class="btn btn-outline-primary quick-product" data-codigo="FILTROAIRE">Filtro Aire Hyundai</button>
        <button type="button" class="btn btn-outline-primary quick-product" data-codigo="205R16">Llanta Goodyear 205/70 R16</button>
        <button type="button" class="btn btn-outline-primary quick-product" data-codigo="1122">Rotaci√≥n de llantas</button>
        <button type="button" class="btn btn-outline-primary quick-product" data-codigo="1123">Alineado</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const tbody = document.getElementById('tbody-productos');
  const totalDisplay = document.getElementById('total-display');
  const venderBtn = document.getElementById('vender-btn');
  const codigoInput = document.getElementById('codigo_input');
  const addByCodeBtn = document.getElementById('add-by-code-btn');
  const errorMsg = document.getElementById('error-msg');
  const totalFormsInput = document.getElementById('id_form-TOTAL_FORMS');

  let productos = [];

  function calcularTotalesJS() {
    // devuelve objeto con totales por tipo
    let subtotal_exento = 0;
    let subtotal_g15 = 0;
    let subtotal_g18 = 0;
    let impuesto_15 = 0;
    let impuesto_18 = 0;
    let total = 0;

    productos.forEach(p => {
      const descuentoFactor = (1 - (parseFloat(p.descuento) || 0) / 100);
      const base = (parseInt(p.cantidad) || 0) * (parseFloat(p.precio_unitario) || 0) * descuentoFactor;
      let impuesto = 0;
      if (p.tipo_impuesto === 'G15') {
        impuesto = parseFloat((base * 0.15).toFixed(2));
        subtotal_g15 += base;
        impuesto_15 += impuesto;
      } else if (p.tipo_impuesto === 'G18') {
        impuesto = parseFloat((base * 0.18).toFixed(2));
        subtotal_g18 += base;
        impuesto_18 += impuesto;
      } else {
        subtotal_exento += base;
      }
      total += base + impuesto;
    });

    return {
      subtotal_exento, subtotal_g15, subtotal_g18,
      impuesto_15, impuesto_18, total
    };
  }

  function renderTabla() {
    tbody.innerHTML = '';
    let contador = 0;
    productos.forEach((p, i) => {
      const descuentoFactor = (1 - (parseFloat(p.descuento) || 0) / 100);
      const base = (parseInt(p.cantidad) || 0) * (parseFloat(p.precio_unitario) || 0) * descuentoFactor;
      let impuesto = 0;
      let impuestoLabel = 'Exento';
      if (p.tipo_impuesto === 'G15') {
        impuesto = base * 0.15;
        impuestoLabel = '15%';
      } else if (p.tipo_impuesto === 'G18') {
        impuesto = base * 0.18;
        impuestoLabel = '18%';
      }

      const subtotalLinea = base + impuesto;

      tbody.innerHTML += `
        <tr>
          <td>${p.codigo}</td>
          <td>${p.nombre}</td>
          <td><input type="number" min="1" value="${p.cantidad}" class="form-control" onchange="actualizarCantidad(${i}, this.value)"></td>
          <td><input type="number" step="0.01" value="${p.precio_unitario}" class="form-control" readonly></td>
          <td><input type="number" step="0.01" value="${p.descuento}" class="form-control" onchange="actualizarDescuento(${i}, this.value)"></td>
          <td>${impuestoLabel}</td>
          <td>L ${(subtotalLinea).toFixed(2)}</td>
          <td><button type="button" class="btn btn-danger btn-sm" onclick="eliminarProducto(${i})">‚ùå</button></td>
        </tr>

        <input type="hidden" name="form-${contador}-producto" value="${p.id}">
        <input type="hidden" name="form-${contador}-cantidad" value="${p.cantidad}">
        <input type="hidden" name="form-${contador}-precio_unitario" value="${p.precio_unitario}">
        <input type="hidden" name="form-${contador}-descuento" value="${p.descuento}">
      `;
      contador++;
    });

    // actualizar total forms y totales visibles
    totalFormsInput.value = productos.length;
    const totales = calcularTotalesJS();
    totalDisplay.textContent = parseFloat(totales.total || 0).toFixed(2);
    venderBtn.disabled = productos.length === 0;
  }

  window.actualizarCantidad = (i, val) => { productos[i].cantidad = parseInt(val) || 1; renderTabla(); };
  window.actualizarDescuento = (i, val) => { productos[i].descuento = parseFloat(val) || 0; renderTabla(); };
  window.eliminarProducto = (i) => { productos.splice(i, 1); renderTabla(); };

  function buscarYAgregar(codigo) {
    errorMsg.textContent = '';
    if (!codigo) { errorMsg.textContent = 'Ingrese un c√≥digo v√°lido'; return; }

    fetch(`/buscar-producto/?codigo=${encodeURIComponent(codigo)}`)
      .then(r => r.json())
      .then(json => {
        if (!json.encontrado) { errorMsg.textContent = 'Producto no encontrado'; return; }

        const existente = productos.find(p => p.id === json.id);
        if (existente) {
          existente.cantidad++;
        } else {
          productos.push({
            id: json.id,
            codigo: json.codigo,
            nombre: json.nombre,
            cantidad: 1,
            precio_unitario: json.precio,
            descuento: 0,
            tipo_impuesto: json.tipo_impuesto || 'E'
          });
        }

        renderTabla();
        codigoInput.value = '';
        codigoInput.focus();
      })
      .catch(() => errorMsg.textContent = 'Error al buscar el producto');
  }

  addByCodeBtn.addEventListener('click', () => buscarYAgregar(codigoInput.value.trim()));
  codigoInput.addEventListener('keypress', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      buscarYAgregar(codigoInput.value.trim());
    }
  });

  document.querySelectorAll('.quick-product').forEach(btn => {
    btn.addEventListener('click', () => buscarYAgregar(btn.getAttribute('data-codigo')));
  });

});
</script>

{% endblock %}
