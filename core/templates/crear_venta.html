{% extends 'base.html' %}
{% block title %}Crear Venta{% endblock %}
{% block content %}

<div class="container mt-4">
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <h2 class="mb-3">üßæ Registrar Venta</h2>

  <form method="post" action="{% url 'crear_venta' %}" id="venta-form">
    {% csrf_token %}
    {{ formset.management_form }}

    <div class="row g-3">
      <!-- Columna izquierda: C√≥digo y cliente -->
      <div class="col-md-4">
        <label class="form-label">üîé C√≥digo o barra:</label>
        <div class="input-group mb-2">
            <input type="text" id="codigo_input" class="form-control" placeholder="Ej: 12345 o ABC001" autofocus>
         <button type="button" class="btn btn-primary btn-sm" id="add-by-code-btn" style="height: 45px; margin-left: 5px;">Agregar</button>
        </div>
        <div id="error-msg" class="text-danger small"></div>

        <h5 class="mt-4">üßç Cliente</h5>
          {{ cliente_form.cliente }}
  

        <div class="mb-2">{{ cliente_form.tipo_pago }}</div>
        
        <!-- Bloque Pagos Mixtos -->
<h5 class="mt-3">üí≥ Pagos</h5>

<div id="pagos-container">
    {{ pago_formset.management_form }}

    <div id="pagos-rows">
        <!-- Las filas se llenar√°n din√°micamente por JS -->
    </div>

    <div class="mt-2">
        <button id="addPagoBtn" type="button" class="btn btn-outline-primary btn-sm">‚ûï Agregar pago</button>
    </div>

    <div class="mt-2">
        <small class="text-muted">La suma de los pagos debe coincidir con el total.</small>
    </div>
</div>


       

        <h5 class="mt-4">üí∞ Total:</h5>
        <h3>L <span id="total-display">0.00</span></h3>

        <button type="submit" class="btn btn-success w-100 mt-3" id="vender-btn" disabled>üí∞ Vender</button>
      </div>

      <!-- Columna central: Tabla de productos -->
      <div class="col-md-8">
        <table class="table table-bordered align-middle" id="tabla-productos">
          <thead class="table-light">
            <tr>
              <th>C√≥digo</th>
              <th>Producto</th>
              <th style="width: 100px;">Cant.</th>
              <th style="width: 120px;">Precio</th>
              <th style="width: 100px;">Desc. %</th>
              <th style="width: 100px;">ISV</th>
              <th>Subtotal</th>

              <th style="width: 60px;">‚ùå</th>
            </tr>
          </thead>
          <tbody id="tbody-productos"></tbody>
        </table>
      </div>
    </div>
  </form>

  <!-- Panel de accesos r√°pidos -->
  <div class="row mt-4">
    <div class="col-md-12">
      <h6>‚ö° Accesos r√°pidos</h6>
      <div class="d-flex flex-wrap gap-2">
        <button type="button" class="btn btn-outline-primary quick-product" data-codigo="ACE-10W30">Aceite Castrol 10W30</button>
        <button type="button" class="btn btn-outline-primary quick-product" data-codigo="BATERIA12V">Bater√≠a 12V</button>
        <button type="button" class="btn btn-outline-primary quick-product" data-codigo="FILTROAIRE">Filtro Aire Hyundai</button>
        <button type="button" class="btn btn-outline-primary quick-product" data-codigo="205R16">Llanta Goodyear 205/70 R16</button>
        <button type="button" class="btn btn-outline-primary quick-product" data-codigo="1122">Rotaci√≥n de llantas</button>
        <button type="button" class="btn btn-outline-primary quick-product" data-codigo="1123">Alineado</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

  /* ===================================================================
     VARIABLES PRINCIPALES
  =================================================================== */
  const tbody = document.getElementById('tbody-productos');
  const totalDisplay = document.getElementById('total-display');
  const venderBtn = document.getElementById('vender-btn');
  const codigoInput = document.getElementById('codigo_input');
  const addByCodeBtn = document.getElementById('add-by-code-btn');
  const errorMsg = document.getElementById('error-msg');
  const totalFormsInput = document.getElementById('id_form-TOTAL_FORMS');

  const pagosRows = document.getElementById("pagos-rows");
  const addPagoBtn = document.getElementById("addPagoBtn");
  const pagosManagementTotal = document.getElementById("id_pagos-TOTAL_FORMS");

  let productos = [];
  let pagos = [];

  const METODOS = [
    { value: "efectivo", label: "Efectivo" },
    { value: "tarjeta", label: "Tarjeta" },
    { value: "transferencia", label: "Transferencia" }
  ];

  const safeNum = v => Number.parseFloat(v) || 0;
  const formatMoney = v => parseFloat(v || 0).toFixed(2);

  /* ===================================================================
     FUNCIONES DE C√ÅLCULO
  =================================================================== */
  function calcularTotalesJS() {
    let subtotal_exento = 0;
    let subtotal_g15 = 0;
    let subtotal_g18 = 0;
    let impuesto_15 = 0;
    let impuesto_18 = 0;
    let total = 0;

    productos.forEach(p => {
      const descFactor = 1 - (safeNum(p.descuento) / 100);
      const base = p.cantidad * p.precio_unitario * descFactor;
      let imp = 0;

      if (p.tipo_impuesto === 'G15') {
        imp = +(base * 0.15).toFixed(2);
        subtotal_g15 += base;
        impuesto_15 += imp;
      } else if (p.tipo_impuesto === 'G18') {
        imp = +(base * 0.18).toFixed(2);
        subtotal_g18 += base;
        impuesto_18 += imp;
      } else {
        subtotal_exento += base;
      }

      total += base + imp;
    });

    return { total };
  }

  /* ===================================================================
     RENDERIZAR TABLA DE PRODUCTOS
  =================================================================== */
  function renderTabla() {
    tbody.innerHTML = '';
    let idx = 0;

    productos.forEach((p, i) => {

      const descFactor = 1 - (safeNum(p.descuento) / 100);
      const base = p.cantidad * p.precio_unitario * descFactor;
      let impuesto = 0;
      let labelISV = "Exento";

      if (p.tipo_impuesto === "G15") {
        impuesto = base * 0.15;
        labelISV = "15%";
      } else if (p.tipo_impuesto === "G18") {
        impuesto = base * 0.18;
        labelISV = "18%";
      }

      const subtotalLinea = base + impuesto;

      tbody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${p.codigo}</td>
          <td>${p.nombre}</td>

          <td>
            <input type="number" min="1" value="${p.cantidad}"
              class="form-control"
              onchange="actualizarCantidad(${i}, this.value)">
          </td>

          <td>
            <input type="number" step="0.01" readonly
              class="form-control"
              value="${p.precio_unitario}">
          </td>

          <td>
            <input type="number" step="0.01"
              class="form-control"
              value="${p.descuento}"
              onchange="actualizarDescuento(${i}, this.value)">
          </td>

          <td>${labelISV}</td>
          <td>L ${subtotalLinea.toFixed(2)}</td>

          <td>
            <button type="button" class="btn btn-danger btn-sm" onclick="eliminarProducto(${i})">‚úñ</button>
          </td>
        </tr>

        <input type="hidden" name="form-${idx}-producto" value="${p.id}">
        <input type="hidden" name="form-${idx}-cantidad" value="${p.cantidad}">
        <input type="hidden" name="form-${idx}-precio_unitario" value="${p.precio_unitario}">
        <input type="hidden" name="form-${idx}-descuento" value="${p.descuento}">
      `);

      idx++;
    });

    totalFormsInput.value = productos.length;

    const totales = calcularTotalesJS();
    totalDisplay.textContent = formatMoney(totales.total);

    syncPrimerPagoConTotal(); 
  }

  window.actualizarCantidad = (i, v) => { productos[i].cantidad = safeNum(v) || 1; renderTabla(); };
  window.actualizarDescuento = (i, v) => { productos[i].descuento = safeNum(v) || 0; renderTabla(); };
  window.eliminarProducto = i => { productos.splice(i, 1); renderTabla(); };

  /* ===================================================================
     BUSCAR Y AGREGAR PRODUCTO
  =================================================================== */
  function buscarYAgregar(codigo) {
    if (!codigo) return errorMsg.textContent = "Ingrese un c√≥digo v√°lido";

    fetch(`/buscar-producto/?codigo=${codigo}`)
      .then(r => r.json())
      .then(data => {
        if (!data.encontrado) return errorMsg.textContent = "Producto no encontrado";

        const existe = productos.find(p => p.id === data.id);
        if (existe) existe.cantidad++;
        else productos.push({
          id: data.id,
          codigo: data.codigo,
          nombre: data.nombre,
          cantidad: 1,
          precio_unitario: parseFloat(data.precio),
          descuento: 0,
          tipo_impuesto: data.tipo_impuesto || 'E'
        });

        renderTabla();
        errorMsg.textContent = "";
        codigoInput.value = "";
        codigoInput.focus();
      })
  }

  addByCodeBtn.onclick = () => buscarYAgregar(codigoInput.value.trim());
  codigoInput.onkeypress = e => { if (e.key === "Enter") { e.preventDefault(); buscarYAgregar(codigoInput.value.trim()); } };
  
  // ‚úÖ BOTONES DE ACCESO R√ÅPIDO
  document.querySelectorAll('.quick-product').forEach(btn => {
    btn.addEventListener('click', () => buscarYAgregar(btn.dataset.codigo));
  });

  /* ===================================================================
     PAGOS MIXTOS - FORMSET FUNCIONANDO 100%
  =================================================================== */

  function renderPagos() {
    pagosRows.innerHTML = '';

    pagos.forEach((p, i) => {
      pagosRows.insertAdjacentHTML(
        "beforeend",
        `
        <div class="row mb-2 pago-row">
          
          <div class="col-5">
            <select class="form-control" 
                    name="pagos-${i}-metodo"
                    onchange="cambiarMetodo(${i}, this.value)">
              ${METODOS.map(m => 
                `<option value="${m.value}" ${m.value === p.metodo ? "selected" : ""}>${m.label}</option>`
              ).join("")}
            </select>
          </div>

          <div class="col-5">
            <input type="number" step="0.01" min="0"
                   class="form-control"
                   name="pagos-${i}-monto"
                   value="${formatMoney(p.monto)}"
                   oninput="cambiarMonto(${i}, this.value)">
          </div>

          <div class="col-1 d-flex align-items-center">
            <button type="button" class="btn btn-danger btn-sm"
                    onclick="eliminarPago(${i})">‚úñ</button>
          </div>

        </div>
        `
      );
    });

    pagosManagementTotal.value = pagos.length;
    validarPagos();
  }

  window.cambiarMetodo = (i, v) => { pagos[i].metodo = v; validarPagos(); };
  window.cambiarMonto = (i, v) => { 
    pagos[i].monto = safeNum(v); 
    // ‚úÖ Si cambio un pago que NO es el primero, ajustar el primero autom√°ticamente
    if (i !== 0) {
      syncPrimerPagoConTotal();
    } else {
      validarPagos();
    }
  };

  window.eliminarPago = i => {
    if (pagos.length > 1) pagos.splice(i, 1);
    renderPagos();
  };

  addPagoBtn.onclick = () => {
    const total = safeNum(totalDisplay.textContent);
    const pagado = pagos.reduce((a, b) => a + safeNum(b.monto), 0);
    pagos.push({ metodo: "efectivo", monto: Math.max(0, total - pagado) });
    renderPagos();
  };

  function syncPrimerPagoConTotal() {
    const total = safeNum(totalDisplay.textContent);
    const resto = pagos.slice(1).reduce((a, b) => a + safeNum(b.monto), 0);
    pagos[0].monto = Math.max(0, total - resto);
    renderPagos();
  }

  function validarPagos() {
    const total = safeNum(totalDisplay.textContent);
    const suma = pagos.reduce((a, b) => a + safeNum(b.monto), 0);
    const productosOK = productos.length > 0;
    const cuadrado = Math.abs(suma - total) < 0.01;

    venderBtn.disabled = !(productosOK && cuadrado);
  }

  /* ===================================================================
     INICIALIZACI√ìN
  =================================================================== */

  pagos = [{ metodo: "efectivo", monto: 0 }];
  renderPagos();
  renderTabla();

}); // END DOMContentLoaded
</script>




{% endblock %}
