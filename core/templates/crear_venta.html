{% extends 'base.html' %}
{% block title %}Crear Venta{% endblock %}
{% block content %}

<div class="contenedor">

  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{% if message.tags %}{{ message.tags }}{% else %}info{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %} 

  <h2>ğŸ§¾ Registrar Venta</h2>
  <br><br>
  <form method="post" action="{% url 'crear_venta' %}" id="venta-form">
    {% csrf_token %}

    <!-- Layout en CUATRO columnas -->
    <div class="venta-layout">
      
      <!-- Columna 1: Accesos rÃ¡pidos izquierda -->
     <div class="columna-accesos panel-rapido">
  <h6>âš¡ Accesos rÃ¡pidos</h6>
  <div class="d-grid gap-2">
    <div class="btn btn-outline-success quick-product" data-codigo="343434">Aceite HidrÃ¡ulico</div>
    <div class="btn btn-outline-success quick-product" data-codigo="353535">Llanta 16</div>
    <div class="btn btn-outline-success quick-product" data-codigo="363636">Llanta 45</div>
    <div class="btn btn-outline-success quick-product" data-codigo="363636">Llanta 45</div>
    <div class="btn btn-outline-success quick-product" data-codigo="363636">Llanta 45</div>
    <div class="btn btn-outline-success quick-product" data-codigo="363636">Llanta 45</div>
  </div>
</div>


      <!-- Columna 2: Buscador + Cliente -->
      <div class="columna-izquierda panel-sombreado">
        <div class="form-group">
          <label for="codigo_input">ğŸ” Buscar producto por ID o cÃ³digo de barra:</label>
          <input type="text" id="codigo_input" placeholder="Ej. 12345 o ABC001" autofocus class="form-control">
          <button type="button" class="btn btn-primary mt-2" id="add-by-code-btn">Agregar</button>
          <div id="error-msg" style="color: red; margin-top: 5px;"></div>
        </div>

        <div class="form-group mt-3">
          <strong>Total:</strong> L <span id="total-display">0.00</span>
        </div>

        <h4 class="mt-3">ğŸ§ Cliente</h4>
        <div class="cliente-form">
          {{ cliente_form.cliente }}
          {{ cliente_form.tipo_pago }}
          {{ cliente_form.cai }}
        </div>

        <div class="botones-acciones mt-3">
          <button type="submit" class="btn btn-success w-100" id="vender-btn" disabled>ğŸ’° Vender</button>
        </div>
      </div>

      <!-- Columna 3: Productos -->
      <div class="columna-centro panel-sombreado">
        <h4>ğŸ›’ Productos</h4>
        {{ formset.management_form }}
        <div id="form-container" class="border p-2" style="min-height:300px; overflow-y:auto;">
          {% for form in formset %}
            <div class="form-row" data-form-index="{{ forloop.counter0 }}">
              {% for hidden in form.hidden_fields %}
                {{ hidden }}
              {% endfor %}

              <div class="cantidad-input">
                {{ form.cantidad.label_tag }}
                {{ form.cantidad }}
              </div>

              <div class="precio-input">
                {{ form.precio_unitario.label_tag }}
                {{ form.precio_unitario }}
                <span class="nombre-producto fw-bold d-block mt-1"></span>
              </div>

              <div class="acciones-producto">
                <button type="button" class="remove-btn">âŒ</button>
                <button type="button" class="discount-btn btn btn-sm btn-warning mt-2">ğŸ’¸-6%</button>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>

      <!-- Columna 4: Accesos rÃ¡pidos derecha -->
      <div class="columna-derecha panel-rapido">
        <h6>âš¡ Accesos rÃ¡pidos</h6>
        <div class="d-grid gap-2">
          <button type="button" class="btn btn-outline-primary quick-product" data-codigo="343434">Aceite HidrÃ¡ulico</button>
          <button type="button" class="btn btn-outline-primary quick-product" data-codigo="353535">Llanta 16</button>
          <button type="button" class="btn btn-outline-primary quick-product" data-codigo="363636">Llanta 45</button>
          <button type="button" class="btn btn-outline-primary quick-product" data-codigo="6767789">Llanta Tractor 76</button>
          <button type="button" class="btn btn-outline-primary quick-product" data-codigo="205/55/16">Llanta Turismos</button>
          <button type="button" class="btn btn-outline-primary quick-product" data-codigo="0">Parcho 18</button>
        </div>
      </div>

    </div>
  </form>
</div> 



  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const formContainer    = document.getElementById('form-container');
    const totalFormsInput  = document.getElementById('id_form-TOTAL_FORMS');
    const addByCodeBtn     = document.getElementById('add-by-code-btn');
    const codigoInput      = document.getElementById('codigo_input');
    const errorMsg         = document.getElementById('error-msg');
    const totalDisplay     = document.getElementById('total-display');
    const venderBtn        = document.getElementById('vender-btn');

    const emptyFormHTML = formContainer.firstElementChild
      ? formContainer.firstElementChild.outerHTML
      : '';

    function verificarProductosActivos() {
      let hayProductos = false;
      const filas = document.querySelectorAll('.form-row');

      filas.forEach(row => {
        const producto = row.querySelector('input[name$="-producto"]');
        const cantidad = row.querySelector('input[name$="-cantidad"]');
        const precio   = row.querySelector('input[name$="-precio_unitario"]');

        if (producto && producto.value &&
            cantidad && parseInt(cantidad.value) > 0 &&
            precio && parseFloat(precio.value) > 0) {
          hayProductos = true;
        }
      });

      venderBtn.disabled = !hayProductos;
    }

    function actualizarTotal() {
      let total = 0;
      document.querySelectorAll('.form-row').forEach(row => {
        const precio = parseFloat(row.querySelector('input[name$="-precio_unitario"]').value) || 0;
        const qty    = parseInt(row.querySelector('input[name$="-cantidad"]').value) || 0;
        total += precio * qty;
      });
      totalDisplay.innerText = total.toFixed(2);
      verificarProductosActivos();
    }

    // ğŸ”¹ Modificado: ahora acepta cÃ³digo directo (desde botones rÃ¡pidos)
    function buscarYAgregar(codigoDirecto = null) {
      const codigo = codigoDirecto ? codigoDirecto.trim() : codigoInput.value.trim();
      if (errorMsg) errorMsg.innerText = '';

      if (!codigo) {
        errorMsg.innerText = 'Ingrese un cÃ³digo vÃ¡lido';
        return;
      }

      fetch(`/buscar-producto/?codigo=${encodeURIComponent(codigo)}`)
        .then(r => r.json())
        .then(json => {
          if (!json.encontrado) {
            errorMsg.innerText = 'Producto no encontrado';
            return;
          }

          // Verificar si ya existe en la lista
          const productosExistentes = document.querySelectorAll('input[name$="-producto"]');
          let productoExiste = false;

          productosExistentes.forEach(inputHidden => {
            if (inputHidden.value == json.id) {
              const row = inputHidden.closest('.form-row');
              const cantidadInput = row.querySelector('input[name$="-cantidad"]');
              if (cantidadInput) {
                cantidadInput.value = parseInt(cantidadInput.value || 0) + 1;
                productoExiste = true;
              }
              // Asegurar que el nombre estÃ© visible
              const nombreSpanExistente = row.querySelector('.nombre-producto');
              if (nombreSpanExistente && !nombreSpanExistente.textContent.trim()) {
                nombreSpanExistente.textContent = json.nombre;
              }
            }
          });

          if (productoExiste) {
            actualizarTotal();
            codigoInput.value = '';
            // Evitar abrir teclado en tablets
            if (!('ontouchstart' in window)) {
              codigoInput.focus();
            }
            return;
          }

          // Agregar nuevo producto al inicio
          const currentCount = parseInt(totalFormsInput.value);
          const tempDiv = document.createElement('div');
          tempDiv.innerHTML = emptyFormHTML.replace(/form-(\d+)-/g, `form-${currentCount}-`);
          const newRow = tempDiv.firstElementChild;

          // Campo oculto producto
          const productoInputHidden = newRow.querySelector(`input[name="form-${currentCount}-producto"]`);
          if (productoInputHidden) productoInputHidden.value = json.id;

          // Mostrar nombre debajo del precio
          const nombreSpan = newRow.querySelector('.nombre-producto');
          if (nombreSpan) nombreSpan.textContent = json.nombre;

          // Cantidad y precio
          const cantidadInput  = newRow.querySelector(`input[name="form-${currentCount}-cantidad"]`);
          const precioInput    = newRow.querySelector(`input[name="form-${currentCount}-precio_unitario"]`);
          if (cantidadInput)  cantidadInput.value  = 1;
          if (precioInput)    precioInput.value    = json.precio;

          formContainer.insertBefore(newRow, formContainer.firstChild);
          totalFormsInput.value = currentCount + 1;
          actualizarTotal();
          codigoInput.value = '';
          codigoInput.focus();
        })
        
        .catch(error => {
          console.error('Error:', error);
          errorMsg.innerText = 'Error al buscar el producto';
        });
    }

    if (addByCodeBtn) {
      addByCodeBtn.addEventListener('click', () => buscarYAgregar());
    }

    if (codigoInput) {
      codigoInput.addEventListener('keypress', e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          buscarYAgregar();
        }
      });
    }

    

    document.addEventListener('input', verificarProductosActivos);
    document.addEventListener('change', verificarProductosActivos);

    // ğŸ”¹ Manejar clic en botones de eliminar producto (eliminar del DOM y reindexar)
    formContainer.addEventListener('click', function(e) {
      if (e.target.classList.contains('remove-btn')) {
        e.preventDefault();
        const row = e.target.closest('.form-row');
        row.remove();

        // Reindexar todos los formularios
        const filas = document.querySelectorAll('.form-row');
        filas.forEach((fila, index) => {
          fila.querySelectorAll('input, select, textarea').forEach(input => {
            input.name = input.name.replace(/form-\d+-/, `form-${index}-`);
            input.id = input.id.replace(/form-\d+-/, `form-${index}-`);
          });
        });

        // Actualizar TOTAL_FORMS
        totalFormsInput.value = filas.length;

        actualizarTotal();
        verificarProductosActivos();
      }

      // ğŸ”¹ Manejar clic en botones de descuento
    if (e.target.classList.contains('discount-btn')) {
    const row = e.target.closest('.form-row');
    const descuentoInput = row.querySelector('input[name$="-descuento"]');

    if (descuentoInput) {
      descuentoInput.value = 6; // ğŸ‘ˆ registrar el % en el form
    }

    e.target.disabled = true;
    e.target.innerText = "âœ” Descuento aplicado";
    actualizarTotal(); // el total se recalcula en backend al guardar
  }


    }); 

    // FunciÃ³n para inicializar nombres de productos en filas existentes
    function inicializarNombresProductos() {
      document.querySelectorAll('.form-row').forEach(row => {
        const productoId = row.querySelector('input[name$="-producto"]')?.value;
        const nombreSpan = row.querySelector('.nombre-producto');

        if (productoId && nombreSpan && !nombreSpan.textContent.trim()) {
          // Buscar el nombre desde el backend
          fetch(`/buscar-producto-id/?id=${encodeURIComponent(productoId)}`)
            .then(r => r.json())
            .then(json => {
              if (json.encontrado) {
                nombreSpan.textContent = json.nombre;
              }
            })
            .catch(err => console.error('Error obteniendo nombre:', err));
        }
      });
    }

    // ğŸ”¹ Limpiar filas vacÃ­as antes de enviar
    document.getElementById('venta-form').addEventListener('submit', function() {
      const filas = document.querySelectorAll('.form-row');
      let index = 0;

      filas.forEach(row => {
        const producto = row.querySelector('input[name$="-producto"]');
        if (!producto || !producto.value) {
          row.remove(); // Elimina fila vacÃ­a
        } else {
          // Reindexar
          row.querySelectorAll('input, select, textarea').forEach(input => {
            input.name = input.name.replace(/form-\d+-/, `form-${index}-`);
            input.id = input.id.replace(/form-\d+-/, `form-${index}-`);
          });
          index++;
        }
      });

      totalFormsInput.value = index;
    });

    // ğŸ”¹ Inicializar
    inicializarNombresProductos();
    actualizarTotal();
    verificarProductosActivos();

    // âš¡ Accesos rÃ¡pidos: botones que agregan producto directo
    document.querySelectorAll('.quick-product').forEach(btn => {
      btn.addEventListener('click', function() {
        const codigo = this.getAttribute('data-codigo');
        buscarYAgregar(codigo); // usamos la misma funciÃ³n
      });
    });
// ğŸ”¹ Inicializar Select2 para clientes
$('#id_cliente').select2({
  placeholder: "Buscar cliente por nombre...",
  allowClear: true,
  minimumInputLength: 1,
  width: '100%',
  ajax: {
    url: "{% url 'buscar_clientes' %}",
    dataType: 'json',
    delay: 250,
    data: function (params) {
      return { q: params.term || '' };
    },
    processResults: function (data) {
      return { results: data.results };
    },
    cache: true
  }
});


// Prevenir que botones tÃ¡ctiles abran teclado
document.querySelectorAll('.quick-product').forEach(btn => {
  btn.addEventListener('touchstart', e => e.preventDefault());
});


});

  </script>



  {% endblock %}      