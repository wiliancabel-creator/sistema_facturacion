{% extends 'base.html' %}
{% load custom_filters %}
{% block title %}Editar Cotizaci√≥n{% endblock %}
{% block content %}

<div class="container mt-4">
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <h2 class="mb-3">‚úèÔ∏è Editar Cotizaci√≥n #{{ cotizacion.id }}</h2>

  <form method="post" action="{% url 'editar_cotizacion' cotizacion.id %}" id="cotizacion-form">
    {% csrf_token %}
    {{ formset.management_form }}

    <div class="row g-3">
      <!-- Columna izquierda -->
      <div class="col-md-4">
        <label class="form-label">üîé Buscar producto:</label>
        <div class="input-group mb-2">
          <input type="text" id="codigo_input" class="form-control" placeholder="Ej: 12345 o ABC001" autofocus>
           <button type="button" class="btn btn-primary btn-sm" id="add-by-code-btn" style="height: 45px; margin-left: 5px;">Agregar</button>
        </div>
        <div id="error-msg" class="text-danger small"></div>

        <h5 class="mt-4">üßç Cliente</h5>
        <div class="mb-2">{{ cotizacion_form.cliente }}</div>

        <h5 class="mt-4">üí∞ Total:</h5>
        <h3>L <span id="total-display">0.00</span></h3>

        <button type="submit" class="btn btn-success w-100 mt-3" id="guardar-btn" disabled>üíæ Guardar Cambios</button>
      </div>

      <!-- Columna derecha: Tabla -->
      <div class="col-md-8">
        <table class="table table-bordered align-middle" id="tabla-productos">
          <thead class="table-light">
            <tr>
              <th>C√≥digo</th>
              <th>Producto</th>
              <th style="width: 100px;">Cant.</th>
              <th style="width: 120px;">Precio</th>
              <th style="width: 100px;">Desc. %</th>
              <th>Subtotal</th>
              <th style="width: 60px;">‚ùå</th>
            </tr>
          </thead>
          <tbody id="tbody-productos"></tbody>
        </table>
      </div>
    </div>
  </form>

  <!-- Accesos r√°pidos -->
  <div class="row mt-4">
    <div class="col-md-12">
      <h6>‚ö° Accesos r√°pidos</h6>
      <div class="d-flex flex-wrap gap-2">
        <button type="button" class="btn btn-outline-primary quick-product" data-codigo="ACEITE10W30">Aceite Castrol 10W30</button>
        <button type="button" class="btn btn-outline-primary quick-product" data-codigo="BAT12V">Bater√≠a 12V</button>
        <button type="button" class="btn btn-outline-primary quick-product" data-codigo="FILTROAIRE">Filtro Aire Hyundai</button>
        <button type="button" class="btn btn-outline-primary quick-product" data-codigo="205R16">Llanta Goodyear 205/70 R16</button>
        <button type="button" class="btn btn-outline-primary quick-product" data-codigo="1122">Rotaci√≥n de llantas</button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const tbody = document.getElementById('tbody-productos');
  const totalDisplay = document.getElementById('total-display');
  const guardarBtn = document.getElementById('guardar-btn');
  const codigoInput = document.getElementById('codigo_input');
  const addByCodeBtn = document.getElementById('add-by-code-btn');
  const errorMsg = document.getElementById('error-msg');
  const totalFormsInput = document.getElementById('id_form-TOTAL_FORMS');

  let productos = [];

  // üîπ Cargar los productos existentes de la cotizaci√≥n
  {% for form in formset.forms %}
    productos.push({
      id: {{ form.initial.producto }},
      codigo: "{{ form.initial.producto|default_if_none:'' }}",
      nombre: "{{ form.initial.producto|get_producto_nombre|default:'' }}",
      cantidad: {{ form.initial.cantidad|default:1 }},
      precio_unitario: {{ form.initial.precio_unitario|default:0 }},
      descuento: {{ form.initial.descuento|default:0 }}
    });
  {% endfor %}

  function renderTabla() {
    tbody.innerHTML = '';
    let total = 0;

    productos.forEach((p, i) => {
      const subtotal = (p.cantidad * p.precio_unitario) * (1 - p.descuento / 100);
      total += subtotal;

      tbody.innerHTML += `
        <tr>
          <td>${p.codigo || '-'}</td>
          <td>${p.nombre}</td>
          <td><input type="number" min="1" value="${p.cantidad}" class="form-control" onchange="actualizarCantidad(${i}, this.value)"></td>
          <td><input type="number" step="0.01" value="${p.precio_unitario}" class="form-control" readonly></td>
          <td><input type="number" step="0.01" value="${p.descuento}" class="form-control" onchange="actualizarDescuento(${i}, this.value)"></td>
          <td>L ${(subtotal).toFixed(2)}</td>
          <td><button type="button" class="btn btn-danger btn-sm" onclick="eliminarProducto(${i})">‚ùå</button></td>
        </tr>
        <input type="hidden" name="form-${i}-producto" value="${p.id}">
        <input type="hidden" name="form-${i}-cantidad" value="${p.cantidad}">
        <input type="hidden" name="form-${i}-precio_unitario" value="${p.precio_unitario}">
        <input type="hidden" name="form-${i}-descuento" value="${p.descuento}">
      `;
    });

    totalFormsInput.value = productos.length;
    totalDisplay.textContent = total.toFixed(2);
    guardarBtn.disabled = productos.length === 0;
  }

  window.actualizarCantidad = (i, val) => { productos[i].cantidad = parseInt(val) || 1; renderTabla(); };
  window.actualizarPrecio = (i, val) => { productos[i].precio_unitario = parseFloat(val) || 0; renderTabla(); };
  window.actualizarDescuento = (i, val) => { productos[i].descuento = parseFloat(val) || 0; renderTabla(); };
  window.eliminarProducto = (i) => { productos.splice(i, 1); renderTabla(); };

  function buscarYAgregar(codigo) {
    errorMsg.textContent = '';
    if (!codigo) {
      errorMsg.textContent = 'Ingrese un c√≥digo v√°lido';
      return;
    }

    fetch(`/buscar-producto/?codigo=${encodeURIComponent(codigo)}`)
      .then(r => r.json())
      .then(json => {
        if (!json.encontrado) {
          errorMsg.textContent = 'Producto no encontrado';
          return;
        }

        const existente = productos.find(p => p.id === json.id);
        if (existente) {
          existente.cantidad++;
        } else {
          productos.push({
            id: json.id,
            codigo: json.codigo,
            nombre: json.nombre,
            cantidad: 1,
            precio_unitario: json.precio,
            descuento: 0
          });
        }

        renderTabla();
        codigoInput.value = '';
        codigoInput.focus();
      })
      .catch(() => errorMsg.textContent = 'Error al buscar el producto');
  }

  addByCodeBtn.addEventListener('click', () => buscarYAgregar(codigoInput.value.trim()));
  codigoInput.addEventListener('keypress', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      buscarYAgregar(codigoInput.value.trim());
    }
  });

  document.querySelectorAll('.quick-product').forEach(btn => {
    btn.addEventListener('click', () => buscarYAgregar(btn.getAttribute('data-codigo')));
  });

  // Inicializar tabla
  renderTabla();
});
</script>

{% endblock %}
