{% extends 'base.html' %}
{% block title %}Factura{% endblock %}
{% block content %}

<style>
/* ================= VISTA T√âRMICA (DEFAULT) ================= */
#ticket {
  max-width: 320px;
  margin: 20px auto;
  font-family: 'Courier New', monospace;
  background: #fff;
  color: #000;
  padding: 12px;
  border: 2px solid #ccc;
  border-radius: 4px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

body:not(.light-mode) #ticket {
  background: #1a1a1a;
  color: #f0f0f0;
  border-color: #555;
}

.center { text-align: center; }
.right  { text-align: right; }
hr { border: 0; border-bottom: 1px dashed #999; margin: 8px 0; }

.detalle-tabla {
  width: 100%;
  font-size: 11px;
  margin-top: 4px;
}

.detalle-tabla th {
  border-bottom: 1px dashed #999;
  padding-bottom: 3px;
  font-size: 10px;
}

.detalle-tabla td {
  padding: 3px 2px;
}

/* ================= VISTA A4 (AL IMPRIMIR) ================= */
@media print {
  /* Ocultar botones */
  #botones-impresion { display: none !important; }
  
  /* IMPRESI√ìN T√âRMICA (por defecto) */
  body.print-termica #ticket {
    max-width: 80mm;
    margin: 0;
    padding: 5mm;
    border: none;
    box-shadow: none;
  }
  
  /* IMPRESI√ìN A4 */
  body.print-a4 #ticket {
    max-width: 100%;
    width: 190mm;
    margin: 0 auto;
    padding: 15mm;
    border: 1px solid #000;
    font-size: 12pt;
  }
  
  body.print-a4 .detalle-tabla {
    font-size: 11pt;
  }
  
  body.print-a4 .detalle-tabla th,
  body.print-a4 .detalle-tabla td {
    padding: 6px 4px;
  }
  
  body.print-a4 hr {
    border-bottom: 1px solid #000;
    margin: 12px 0;
  }
}

/* Botones de impresi√≥n */
#botones-impresion {
  text-align: center;
  margin: 20px 0;
  padding: 15px;
  background: var(--card-dark);
  border-radius: 8px;
  max-width: 500px;
  margin: 20px auto;
}

body.light-mode #botones-impresion {
  background: var(--card-light);
}

#botones-impresion .btn {
  margin: 5px;
  min-width: 180px;
  padding: 12px 20px;
  font-size: 16px;
  font-weight: 600;
}

.ticket-header {
  font-size: 14px;
  font-weight: bold;
  margin-bottom: 8px;
}

.ticket-empresa {
  font-size: 16px;
  font-weight: bold;
  margin-bottom: 4px;
}

.total-final {
  font-size: 18px;
  font-weight: bold;
  margin: 10px 0;
}

.pagos-lista {
  list-style: none;
  padding: 0;
  margin: 8px 0;
}

.pagos-lista li {
  padding: 4px 0;
  border-bottom: 1px dotted #999;
}
</style>

<div id="ticket">

  <!-- ENCABEZADO DEL NEGOCIO -->
  <div class="center ticket-empresa">
    {{ empresa.nombre }}
  </div>
  <div class="center" style="font-size: 11px;">
    RTN: {{ empresa.rtn }}<br>
    {{ empresa.direccion }}<br>
    Tel: {{ empresa.telefono }}<br>
    {{ empresa.correo }}
  </div>

  <hr>

  <!-- NUMERO DE FACTURA -->
  <div class="center ticket-header">
    FACTURA N¬∞ {{ venta.numero_factura }}
  </div>

  <hr>

  <!-- CAI Y RANGOS -->
  <div style="font-size: 11px;">
    <strong>CAI:</strong>
    {% if venta.cai %}{{ venta.cai.codigo }}{% else %}SIN CAI{% endif %}<br>

    {% if venta.cai %}
      <strong>Rango Autorizado:</strong><br>
      {{ venta.cai.prefijo }}{{ venta.cai.rango_inicial|stringformat:"08d" }}
      al
      {{ venta.cai.prefijo }}{{ venta.cai.rango_final|stringformat:"08d" }}<br>

      <strong>Fecha L√≠mite:</strong> {{ venta.cai.fecha_limite|date:"d/m/Y" }}<br>
    {% endif %}

    <strong>Fecha Emisi√≥n:</strong> {{ venta.fecha|date:"d/m/Y H:i" }}<br>
    <strong>Tipo Pago:</strong> {{ venta.tipo_pago|title }}
  </div>

  <hr>

  <!-- PAGOS -->
  <div style="font-size: 11px;">
    <strong>Forma(s) de Pago:</strong>
    <ul class="pagos-lista">
      {% for pago in venta.pagos.all %}
        <li>
          {{ pago.get_metodo_display }}: L {{ pago.monto|floatformat:2 }}
          {% if pago.referencia %} - Ref: {{ pago.referencia }}{% endif %}
        </li>
      {% endfor %}
    </ul>
  </div>

  <hr>

  <!-- DATOS DEL CLIENTE -->
  <div style="font-size: 11px;">
    <strong>CLIENTE:</strong> {{ venta.cliente.nombre }}<br>
    {% if venta.cliente.rtn %}<strong>RTN:</strong> {{ venta.cliente.rtn }}<br>{% endif %}
    {% if venta.cliente.direccion %}<strong>Direcci√≥n:</strong> {{ venta.cliente.direccion }}<br>{% endif %}
    {% if venta.cliente.telefono %}<strong>Tel√©fono:</strong> {{ venta.cliente.telefono }}<br>{% endif %}
  </div>

  <hr>

  <div class="center" style="font-weight: bold; margin: 8px 0;">
    DETALLE DE PRODUCTOS
  </div>

  {% for item in detalles %}

    <div style="font-weight:bold; margin-top:8px; font-size: 12px;">
      {{ item.producto.nombre }}
    </div>

    <table class="detalle-tabla">
      <thead>
        <tr>
          <th>Cant</th>
          <th>Precio</th>
          <th>Desc</th>
          <th>ISV</th>
          <th class="right">Subtotal</th>
        </tr>
      </thead>

      <tbody>
        <tr>
          <td>{{ item.cantidad }}</td>
          <td>L {{ item.precio_unitario|floatformat:2 }}</td>
          <td>{{ item.descuento|floatformat:1 }}%</td>
          <td>
            {% if item.producto.tipo_impuesto == 'G15' %}15%
            {% elif item.producto.tipo_impuesto == 'G18' %}18%
            {% else %}Exento
            {% endif %}
          </td>
          <td class="right">L {{ item.total_linea|floatformat:2 }}</td>
        </tr>
      </tbody>
    </table>

  {% endfor %}

  <hr>

  <!-- TOTALES FISCALES -->
  <div style="font-size: 11px;">
    <strong>RESUMEN DE IMPUESTOS:</strong><br>
    <table style="width: 100%; margin-top: 4px;">
      <tr>
        <td>Importe Exento:</td>
        <td class="right">L {{ venta.subtotal_exento|floatformat:2 }}</td>
      </tr>
      <tr>
        <td>Importe Gravado 15%:</td>
        <td class="right">L {{ venta.subtotal_g15|floatformat:2 }}</td>
      </tr>
      <tr>
        <td>Importe Gravado 18%:</td>
        <td class="right">L {{ venta.subtotal_g18|floatformat:2 }}</td>
      </tr>
      <tr>
        <td>ISV 15%:</td>
        <td class="right">L {{ venta.impuesto_15|floatformat:2 }}</td>
      </tr>
      <tr>
        <td>ISV 18%:</td>
        <td class="right">L {{ venta.impuesto_18|floatformat:2 }}</td>
      </tr>
    </table>
  </div>

  <hr style="border-bottom: 2px solid #000;">

  <div class="center total-final">
    TOTAL A PAGAR: L {{ venta.total|floatformat:2 }}
  </div>

  <hr>

  <div style="font-size: 11px;">
    <strong>SON:</strong> {{ total_letras }}
  </div>

  <br>

  <div class="center" style="font-size: 10px; margin-top: 15px;">
    _________________________________<br>
    FIRMA DEL CLIENTE
  </div>

  <br>

  <div class="center" style="font-size: 9px; font-style: italic;">
    ¬°Gracias por su compra!<br>
    Sistema Fajardo
  </div>

</div>

<!-- BOTONES DE IMPRESI√ìN -->
<div id="botones-impresion">
  <h5 class="mb-3">Seleccione tipo de impresi√≥n:</h5>
  <button onclick="imprimirTermica()" class="btn btn-primary">
    üñ®Ô∏è Imprimir T√©rmica (58/80mm)
  </button>
  <button onclick="imprimirA4()" class="btn btn-success">
    üìÑ Imprimir en A4
  </button>
  <a href="{% url 'resumen_ventas' %}" class="btn btn-secondary">
    ‚Üê Volver a Ventas
  </a>
</div>

<script>
function imprimirTermica() {
  // Agregar clase para impresi√≥n t√©rmica
  document.body.classList.add('print-termica');
  document.body.classList.remove('print-a4');
  
  // Configurar para impresora t√©rmica
  setTimeout(() => {
    window.print();
    // Limpiar clases despu√©s de imprimir
    setTimeout(() => {
      document.body.classList.remove('print-termica');
    }, 500);
  }, 100);
}

function imprimirA4() {
  // Agregar clase para impresi√≥n A4
  document.body.classList.add('print-a4');
  document.body.classList.remove('print-termica');
  
  // Configurar para A4
  setTimeout(() => {
    window.print();
    // Limpiar clases despu√©s de imprimir
    setTimeout(() => {
      document.body.classList.remove('print-a4');
    }, 500);
  }, 100);
}

// Detectar tecla de impresi√≥n r√°pida
document.addEventListener('keydown', (e) => {
  // Ctrl + P = T√©rmica
  if (e.ctrlKey && e.key === 'p') {
    e.preventDefault();
    imprimirTermica();
  }
  // Ctrl + Shift + P = A4
  if (e.ctrlKey && e.shiftKey && e.key === 'P') {
    e.preventDefault();
    imprimirA4();
  }
});
</script>

{% endblock %}






