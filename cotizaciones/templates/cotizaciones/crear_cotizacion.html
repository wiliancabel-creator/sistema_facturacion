{% extends 'base.html' %}
{% block title %}Crear Cotizaci√≥n{% endblock %}
{% block content %}

<div class="container mt-4">
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }}">{{ message }}</div>
    {% endfor %}
  {% endif %}



  
  <h2 class="mb-3">üßæ Registrar Cotizaci√≥n</h2> 

  <form method="post" action="{% url 'cotizaciones:crear_cotizacion' %}" id="cotizacion-form">
    
    {% csrf_token %}
    {{ formset.management_form }}

    <div class="row g-3">
      <!-- Columna izquierda: C√≥digo y cliente -->
      <div class="col-md-4">
        <label class="form-label">üîé C√≥digo o barra:</label>
        <div class="autocomplete-container">
    <div class="input-group mb-2">
        <input type="text" id="codigo_input" class="form-control" placeholder="Buscar por c√≥digo, nombre o c√≥digo de barra..." autofocus>
        <button type="button" class="btn btn-primary btn-sm" id="add-by-code-btn" style="height: 45px; margin-left: 5px;">Agregar</button>
    </div>
    <div class="autocomplete-suggestions" id="suggestions-box"></div>
    
</div>
        <div id="error-msg" class="text-danger small"></div>

        <h5 class="mt-4">üßç Cliente</h5>
<div class="autocomplete-container mb-3">
  <div class="input-group">
    <input type="text" id="cliente-input" class="form-control" placeholder="Buscar cliente o usar Consumidor Final..." autocomplete="off">
    <button type="button" class="btn btn-success btn-sm" id="btn-nuevo-cliente" title="Agregar nuevo cliente">
      ‚ûï
    </button>
    
  </div>
  <input type="hidden" name="cliente" id="cliente-id" required>
  <div id="cliente-suggestions" class="autocomplete-suggestions"></div>
</div>
<button type="button" class="btn btn-outline-primary btn-sm w-100 mb-3" id="btn-consumidor-final">
  üë§ Usar Consumidor Final
</button>
<small class="text-muted d-block mb-3">Cliente seleccionado: <strong id="cliente-nombre-display">Ninguno</strong></small>
  

        <div class="mb-2">{{ cotizacion_form.tipo_pago }}</div>

        
       


       

        <h5 class="mt-4">üí∞ Total:</h5>
        <h3>L <span id="total-display">0.00</span></h3>

        <button type="submit" class="btn btn-success w-100 mt-3" id="vender-btn" disabled>üí∞ Registrar Cotizaci√≥n</button>
      </div>

      <!-- Columna central: Tabla de productos -->
      <div class="col-md-8">
        <table class="table table-bordered align-middle" id="tabla-productos">
          <thead class="table-light">
            <tr>
              <th>C√≥digo</th>
              <th>Codgio barra</th>
              <th style="width: 150px;">Producto</th>
              <th>Stock</th>

              <th style="width: 70px;">Cant.</th>
              <th style="width: 80px;">Precio</th>
              <th style="width: 80px;">Desc. %</th>
              <th style="width: 100px;">ISV</th>
              <th>Subtotal</th>

              <th style="width: 60px;">‚ùå</th>
            </tr>
          </thead>
          <tbody id="tbody-productos"></tbody>
        </table>
      </div>
    </div>
  </form>

  <!-- Panel de accesos r√°pidos -->
  <div class="row mt-4">
    <div class="col-md-12">
      <h6>‚ö° Accesos r√°pidos</h6>
      <div class="d-flex flex-wrap gap-2">
        <button type="button" class="btn btn-outline-primary quick-product" data-codigo="ACE-10W30">Aceite Castrol 10W30</button>
        <button type="button" class="btn btn-outline-primary quick-product" data-codigo="BATERIA12V">Bater√≠a 12V</button>
        <button type="button" class="btn btn-outline-primary quick-product" data-codigo="FILTROAIRE">Filtro Aire Hyundai</button>
        <button type="button" class="btn btn-outline-primary quick-product" data-codigo="205R16">Llanta Goodyear 205/70 R16</button>
        <button type="button" class="btn btn-outline-primary quick-product" data-codigo="1122">Rotaci√≥n de llantas</button>
        <button type="button" class="btn btn-outline-primary quick-product" data-codigo="1123">Alineado</button>
      </div>
    </div>
  </div>
</div>


<!-- ========== MODAL NUEVO CLIENTE ========== -->
<div class="modal fade" id="modalNuevoCliente" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">‚ûï Agregar Nuevo Cliente</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="form-nuevo-cliente">
          {% csrf_token %}
          <div class="mb-3">
            <label class="form-label">Nombre *</label>
            <input type="text" name="nombre" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">RTN</label>
            <input type="text" name="rtn" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Tel√©fono</label>
            <input type="text" name="telefono" class="form-control">
          </div>
          <div class="mb-3">
            <label class="form-label">Direcci√≥n</label>
            <textarea name="direccion" class="form-control" rows="2"></textarea>
          </div>
          <div id="error-cliente" class="alert alert-danger d-none"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-success" id="btn-guardar-cliente">üíæ Guardar Cliente</button>
      </div>
    </div>
  </div>
</div>





<style>
.autocomplete-container {
    position: relative;
}

.autocomplete-suggestions {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: var(--bs-body-bg, #2d3748);  /* üåô Se adapta al tema */
    color: var(--bs-body-color, #fff);
    border: 1px solid var(--bs-border-color, #4a5568);
    border-top: none;
    border-radius: 0 0 4px 4px;
    max-height: 300px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    display: none;
}

.autocomplete-suggestions.show {
    display: block;
}

.autocomplete-item {
    padding: 10px;
    cursor: pointer;
    border-bottom: 1px solid var(--bs-border-color, #4a5568);
    transition: background-color 0.2s;
}

.autocomplete-item:hover {
    background-color: #007bff;
    color: white;
}

.autocomplete-item:last-child {
    border-bottom: none;
}

.autocomplete-item strong {
    color: inherit;
}

.autocomplete-item small {
    display: block;
    opacity: 0.8;
    margin-top: 4px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {

  /* ===================================================================
     VARIABLES PRINCIPALES
  =================================================================== */
  const tbody = document.getElementById('tbody-productos');
  const totalDisplay = document.getElementById('total-display');
  const venderBtn = document.getElementById('vender-btn');
  const codigoInput = document.getElementById('codigo_input');
  const addByCodeBtn = document.getElementById('add-by-code-btn');
  const errorMsg = document.getElementById('error-msg');
  const totalFormsInput = document.getElementById('id_form-TOTAL_FORMS');

  let productos = [];

  const safeNum = v => Number.parseFloat(v) || 0;
  const formatMoney = v => parseFloat(v || 0).toFixed(2);

  /* ===================================================================
     HABILITAR BOT√ìN
  =================================================================== */
  function actualizarEstadoBoton() {
    const clienteId = (document.getElementById('cliente-id').value || '').trim();
    const clienteOK = clienteId !== '';
    const productosOK = productos.length > 0;
    venderBtn.disabled = !(clienteOK && productosOK);
  }

  /* ===================================================================
     FUNCIONES DE C√ÅLCULO
  =================================================================== */
  function calcularTotalesJS() {
    let total = 0;

    productos.forEach(p => {
      const descFactor = 1 - (safeNum(p.descuento) / 100);
      const base = p.cantidad * p.precio_unitario * descFactor;

      let imp = 0;
      if (p.tipo_impuesto === 'G15') imp = +(base * 0.15).toFixed(2);
      else if (p.tipo_impuesto === 'G18') imp = +(base * 0.18).toFixed(2);

      total += base + imp;
    });

    return { total };
  }

  /* ===================================================================
     RENDERIZAR TABLA DE PRODUCTOS
  =================================================================== */
  function renderTabla() {
    tbody.innerHTML = '';
    let idx = 0;

    productos.forEach((p, i) => {
      const descFactor = 1 - (safeNum(p.descuento) / 100);
      const base = p.cantidad * p.precio_unitario * descFactor;

      let impuesto = 0;
      let labelISV = "Exento";

      if (p.tipo_impuesto === "G15") {
        impuesto = base * 0.15;
        labelISV = "15%";
      } else if (p.tipo_impuesto === "G18") {
        impuesto = base * 0.18;
        labelISV = "18%";
      }

      const subtotalLinea = base + impuesto;

      tbody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${p.codigo}</td>
          <td>${p.codigo_barra || 'N/A'}</td>
          <td>${p.nombre}</td>
          <td class="${p.stock <= 0 ? 'bg-danger text-white' : p.stock <= 5 ? 'bg-warning' : ''}">
            ${p.stock}
          </td>

          <td>
            <input type="number" min="1" value="${p.cantidad}"
              class="form-control"
              onchange="actualizarCantidad(${i}, this.value)">
          </td>

          <td>
            <input type="number" step="0.01" readonly
              class="form-control"
              value="${p.precio_unitario}">
          </td>

          <td>
            <input type="number" step="0.01"
              class="form-control"
              value="${p.descuento}"
              onchange="actualizarDescuento(${i}, this.value)">
          </td>

          <td>${labelISV}</td>
          <td>L ${subtotalLinea.toFixed(2)}</td>

          <td>
            <button type="button" class="btn btn-danger btn-sm" onclick="eliminarProducto(${i})">‚úñ</button>
          </td>
        </tr>

        <input type="hidden" name="form-${idx}-producto" value="${p.id}">
        <input type="hidden" name="form-${idx}-cantidad" value="${p.cantidad}">
        <input type="hidden" name="form-${idx}-precio_unitario" value="${p.precio_unitario}">
        <input type="hidden" name="form-${idx}-descuento" value="${p.descuento}">
      `);

      idx++;
    });

    totalFormsInput.value = productos.length;

    const totales = calcularTotalesJS();
    totalDisplay.textContent = formatMoney(totales.total);

    actualizarEstadoBoton();
  }

  window.actualizarCantidad = (i, v) => { productos[i].cantidad = safeNum(v) || 1; renderTabla(); };
  window.actualizarDescuento = (i, v) => { productos[i].descuento = safeNum(v) || 0; renderTabla(); };
  window.eliminarProducto = i => { productos.splice(i, 1); renderTabla(); };

  /* ===================================================================
     BUSCAR Y AGREGAR PRODUCTO (ENTER / BOT√ìN)
  =================================================================== */
  function buscarYAgregar(codigo) {
    if (!codigo) return errorMsg.textContent = "Ingrese un c√≥digo v√°lido";

    fetch(`/buscar-producto/?codigo=${encodeURIComponent(codigo)}`)
      .then(r => r.json())
      .then(data => {
        if (!data.encontrado) {
          errorMsg.textContent = data.error || "Producto no encontrado";
          return;
        }

        const existe = productos.find(p => p.id === data.id);
        if (existe) {
          existe.cantidad++;
        } else {
          productos.push({
            id: data.id,
            codigo: data.codigo,
            codigo_barra: data.codigo_barra || '',
            nombre: data.nombre,
            stock: data.stock,
            cantidad: 1,
            precio_unitario: parseFloat(data.precio),
            descuento: 0,
            tipo_impuesto: data.tipo_impuesto || 'E'
          });
        }

        renderTabla();
        errorMsg.textContent = "";
        codigoInput.value = "";
        codigoInput.focus();
      })
      .catch(err => {
        console.error('Error:', err);
        errorMsg.textContent = "Error al buscar producto";
      });
  }

  addByCodeBtn.onclick = () => buscarYAgregar(codigoInput.value.trim());
  codigoInput.onkeypress = e => {
    if (e.key === "Enter") {
      e.preventDefault();
      buscarYAgregar(codigoInput.value.trim());
    }
  };

  /* ===================================================================
     AUTOCOMPLETADO DE PRODUCTOS
  =================================================================== */
  const suggestionsBox = document.getElementById('suggestions-box');
  let timeoutId = null;

  codigoInput.addEventListener('input', (e) => {
    const query = e.target.value.trim();
    clearTimeout(timeoutId);

    if (query.length < 2) {
      suggestionsBox.classList.remove('show');
      return;
    }

    timeoutId = setTimeout(() => {
      fetch(`/sugerencias-productos/?q=${encodeURIComponent(query)}`)
        .then(r => r.json())
        .then(data => {
          if (data.productos && data.productos.length > 0) {
            mostrarSugerenciasProductos(data.productos);
          } else {
            suggestionsBox.classList.remove('show');
          }
        })
        .catch(err => {
          console.error('Error al buscar sugerencias:', err);
          suggestionsBox.classList.remove('show');
        });
    }, 300);
  });

  function mostrarSugerenciasProductos(sugerencias) {
    suggestionsBox.innerHTML = '';

    sugerencias.forEach(p => {
      const item = document.createElement('div');
      item.className = 'autocomplete-item';
      item.innerHTML = `
        <strong>${p.codigo}</strong> - ${p.nombre}
        <small>C√≥digo de barra: ${p.codigo_barra || 'N/A'} | Precio: L ${p.precio} | Stock: ${p.stock}</small>
      `;

      item.addEventListener('click', () => {
        const existeEnTabla = productos.find(prod => prod.id === p.id);

        if (existeEnTabla) existeEnTabla.cantidad++;
        else {
          productos.push({
            id: p.id,
            codigo: p.codigo,
            codigo_barra: p.codigo_barra || '',
            nombre: p.nombre,
            stock: p.stock,
            cantidad: 1,
            precio_unitario: parseFloat(p.precio),
            descuento: 0,
            tipo_impuesto: p.tipo_impuesto || 'E'
          });
        }

        renderTabla();
        codigoInput.value = '';
        suggestionsBox.classList.remove('show');
        codigoInput.focus();
      });

      suggestionsBox.appendChild(item);
    });

    suggestionsBox.classList.add('show');
  }

  document.addEventListener('click', (e) => {
    if (!codigoInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
      suggestionsBox.classList.remove('show');
    }
  });

  // ‚úÖ BOTONES DE ACCESO R√ÅPIDO
  document.querySelectorAll('.quick-product').forEach(btn => {
    btn.addEventListener('click', () => buscarYAgregar(btn.dataset.codigo));
  });

  /* ===================================================================
     SUBMIT: VALIDAR CLIENTE + PRODUCTOS
  =================================================================== */
  document.getElementById('cotizacion-form').addEventListener('submit', function(e) {
    const clienteId = (document.getElementById('cliente-id').value || '').trim();
    const hayProductos = productos.length > 0;

    if (!hayProductos) {
      e.preventDefault();
      alert('‚ö†Ô∏è Debe agregar al menos un producto a la cotizaci√≥n.');
      return false;
    }

    if (!clienteId) {
      e.preventDefault();
      alert('‚ö†Ô∏è Debe seleccionar un cliente.');
      return false;
    }
  });

  // inicial
  renderTabla();
  actualizarEstadoBoton();

}); // END DOMContentLoaded

/* ===================================================================
   BUSCADOR DIN√ÅMICO DE CLIENTES
=================================================================== */
const clienteInput = document.getElementById('cliente-input');
const clienteSuggestions = document.getElementById('cliente-suggestions');
const clienteIdInput = document.getElementById('cliente-id');
const clienteNombreDisplay = document.getElementById('cliente-nombre-display');
const venderBtnGlobal = document.getElementById('vender-btn');

let timeoutCliente = null;

clienteInput.addEventListener('input', (e) => {
  const query = e.target.value.trim();
  clearTimeout(timeoutCliente);

  if (query.length < 2) {
    clienteSuggestions.classList.remove('show');
    return;
  }

  timeoutCliente = setTimeout(() => {
    fetch(`/sugerencias-clientes/?q=${encodeURIComponent(query)}`)
      .then(r => r.json())
      .then(data => {
        if (data.clientes && data.clientes.length > 0) {
          mostrarSugerenciasClientes(data.clientes);
        } else {
          clienteSuggestions.classList.remove('show');
        }
      })
      .catch(err => console.error('Error:', err));
  }, 300);
});

function mostrarSugerenciasClientes(clientes) {
  clienteSuggestions.innerHTML = '';

  clientes.forEach(c => {
    const item = document.createElement('div');
    item.className = 'autocomplete-item';
    item.innerHTML = `
      <strong>${c.nombre}</strong>
      <small>${c.rtn ? `RTN: ${c.rtn}` : ''} ${c.telefono ? `| Tel: ${c.telefono}` : ''}</small>
    `;

    item.addEventListener('click', () => {
      clienteInput.value = c.nombre;
      clienteIdInput.value = c.id;
      clienteNombreDisplay.textContent = c.nombre;
      clienteSuggestions.classList.remove('show');

      // habilitar si ya hay productos
      venderBtnGlobal.disabled = !(document.querySelectorAll('#tbody-productos tr').length > 0 && clienteIdInput.value.trim() !== '');
    });

    clienteSuggestions.appendChild(item);
  });

  clienteSuggestions.classList.add('show');
}

document.addEventListener('click', (e) => {
  if (!clienteInput.contains(e.target) && !clienteSuggestions.contains(e.target)) {
    clienteSuggestions.classList.remove('show');
  }
});

// ========== BOT√ìN CONSUMIDOR FINAL ==========
document.getElementById('btn-consumidor-final').addEventListener('click', () => {
  fetch('/sugerencias-clientes/?q=CONSUMIDOR')
    .then(r => r.json())
    .then(data => {
      if (data.clientes && data.clientes.length > 0) {
        const consumidor = data.clientes.find(c => c.nombre.toUpperCase().includes('CONSUMIDOR FINAL'));
        if (consumidor) {
          clienteInput.value = consumidor.nombre;
          clienteIdInput.value = consumidor.id;
          clienteNombreDisplay.textContent = consumidor.nombre;

          venderBtnGlobal.disabled = !(document.querySelectorAll('#tbody-productos tr').length > 0 && clienteIdInput.value.trim() !== '');
        } else {
          alert('No se encontr√≥ el cliente CONSUMIDOR FINAL en la base de datos');
        }
      }
    });
});

// ========== MODAL NUEVO CLIENTE ==========
document.getElementById('btn-nuevo-cliente').addEventListener('click', () => {
  const modal = new bootstrap.Modal(document.getElementById('modalNuevoCliente'));
  modal.show();
});

document.getElementById('btn-guardar-cliente').addEventListener('click', () => {
  const formData = new FormData(document.getElementById('form-nuevo-cliente'));

  fetch('/crear-cliente-ajax/', {
    method: 'POST',
    body: formData,
    headers: {'X-CSRFToken': formData.get('csrfmiddlewaretoken')}
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      clienteInput.value = data.cliente.nombre;
      clienteIdInput.value = data.cliente.id;
      clienteNombreDisplay.textContent = data.cliente.nombre;
      bootstrap.Modal.getInstance(document.getElementById('modalNuevoCliente')).hide();
      document.getElementById('form-nuevo-cliente').reset();
      document.getElementById('error-cliente').classList.add('d-none');

      venderBtnGlobal.disabled = !(document.querySelectorAll('#tbody-productos tr').length > 0 && clienteIdInput.value.trim() !== '');
    } else {
      document.getElementById('error-cliente').textContent = data.error || 'Error al crear cliente';
      document.getElementById('error-cliente').classList.remove('d-none');
    }
  })
  .catch(() => {
    document.getElementById('error-cliente').textContent = 'Error de conexi√≥n';
    document.getElementById('error-cliente').classList.remove('d-none');
  });
});
</script>


{% endblock %}